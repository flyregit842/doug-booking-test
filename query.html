<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查詢預約 - 機場接送服務</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin: 0 5px;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .booking-list {
            margin-top: 30px;
        }

        .booking-item {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .booking-item:hover {
            border-color: #4CAF50;
        }

        .booking-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .booking-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .booking-details {
            padding: 20px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 12px;
            flex-wrap: wrap;
            min-height: 24px;
        }

        .detail-label {
            font-weight: bold;
            color: #555;
            min-width: 120px;
            margin-right: 10px;
            text-align: right;
            padding-right: 10px;
        }

        .detail-value {
            color: #333;
            flex: 1;
            font-size: 16px;
        }

        .datetime-highlight {
            color: #2196F3;
            font-weight: bold;
            font-size: 18px;
        }

        .schedule-highlight {
            color: #FF9800;
            font-weight: bold;
        }

        .booking-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .edit-form {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: none;
        }

        .edit-form.show {
            display: block;
        }

        .edit-form .form-group {
            margin-bottom: 15px;
        }

        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .edit-form textarea {
            height: 80px;
            resize: vertical;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .back-home {
            text-align: center;
            margin-top: 30px;
        }

        .contact-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
            color: #1565c0;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .content {
                padding: 20px;
            }

            .booking-actions {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
                margin: 5px 0;
            }

            .detail-row {
                flex-direction: column;
            }

            .detail-label {
                min-width: auto;
                margin-bottom: 5px;
                text-align: left;
                padding-right: 0;
            }

            .edit-actions {
                flex-direction: column;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>查詢預約</h1>
            <p>輸入手機號碼查看您的預約記錄</p>
        </div>

        <div class="content">
            <div class="search-section">
                <div class="form-group">
                    <label for="searchPhone">手機號碼</label>
                    <input type="tel" id="searchPhone" placeholder="請輸入手機號碼" maxlength="10">
                </div>
                <button class="btn" onclick="searchBookings()">查詢預約</button>
            </div>

            <div id="messageArea"></div>
            <div id="bookingListArea"></div>

            <div class="back-home">
                <button class="btn btn-secondary" onclick="goHome()">返回首頁</button>
            </div>

            <div class="contact-info">
                服務電郵：jg0989280920@gmail.com
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">確認操作</h3>
            <p id="modalMessage">您確定要執行此操作嗎？</p>
            <div class="modal-actions">
                <button class="btn btn-secondary btn-small" onclick="closeModal()">取消</button>
                <button class="btn btn-danger btn-small" onclick="confirmAction()">確認</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbwmXgTbydw-G5-WLvE0PMBB8Qbi3Umq3yOl91a7c-Y9iiIlEhHOikLZHjDf5VS0H-4npw/exec'
        };

        let currentAction = null;
        let currentBookingData = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupPhoneInput();
        });

        function setupPhoneInput() {
            const phoneInput = document.getElementById('searchPhone');
            
            phoneInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^\d]/g, '');
            });

            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBookings();
                }
            });
        }

        async function searchBookings() {
            const phone = document.getElementById('searchPhone').value.trim();
            
            if (!validatePhone(phone)) {
                showMessage('請輸入正確的手機號碼（10位數字）', 'error');
                return;
            }

            showLoading();
            
            try {
                const formData = new URLSearchParams();
                formData.append('action', 'getBookingsByPhone');
                formData.append('phone', phone);

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    displayBookings(result.bookings || []);
                } else {
                    showMessage(result.message || '查詢失敗，請稍後再試', 'error');
                }
            } catch (error) {
                console.error('查詢錯誤:', error);
                showMessage('網路連線異常，請檢查網路連線後重試', 'error');
            }
        }

        function validatePhone(phone) {
            return /^09\d{8}$/.test(phone);
        }

        function showLoading() {
            document.getElementById('messageArea').innerHTML = '<div class="loading">查詢中，請稍候...</div>';
            document.getElementById('bookingListArea').innerHTML = '';
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function displayBookings(bookings) {
            const messageArea = document.getElementById('messageArea');
            const listArea = document.getElementById('bookingListArea');
            
            if (bookings.length === 0) {
                messageArea.innerHTML = '<div class="error">未找到相關預約記錄</div>';
                listArea.innerHTML = '';
                return;
            }

            messageArea.innerHTML = `<div class="success">找到 ${bookings.length} 筆預約記錄</div>`;
            
            bookings.sort((a, b) => {
                const dateTimeA = new Date(`${a.date} ${a.time}`);
                const dateTimeB = new Date(`${b.date} ${b.time}`);
                return dateTimeB - dateTimeA;
            });

            const listHTML = bookings.map((booking, index) => {
                const bookingDateTime = new Date(`${booking.date} ${booking.time}`);
                const now = new Date();
                const isCompleted = bookingDateTime < now;
                const statusClass = isCompleted ? 'status-completed' : 'status-pending';
                const statusText = isCompleted ? '已完成' : '未完成';

                return `
                    <div class="booking-item">
                        <div class="booking-header">
                            <h3>預約 #${index + 1}</h3>
                            <span class="booking-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="booking-details">
                            <div class="detail-row">
                                <span class="detail-label">日期時間:</span>
                                <span class="detail-value datetime-highlight">${booking.dateTime || booking.date + ' ' + booking.time}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">服務項目:</span>
                                <span class="detail-value">${booking.service}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">期務時間:</span>
                                <span class="detail-value schedule-highlight">${booking.scheduleTime || booking.date + ' ' + booking.time}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">乘客:</span>
                                <span class="detail-value">${booking.passengers}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">航班編號:</span>
                                <span class="detail-value">${booking.flight || ''}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">上車點:</span>
                                <span class="detail-value">${booking.departure}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">下車點:</span>
                                <span class="detail-value">${booking.destination}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">備註:</span>
                                <span class="detail-value">${booking.notes || ''}</span>
                            </div>
                        </div>
                        
                        <div class="edit-form" id="editForm${index}">
                            <div class="form-group">
                                <label>預約日期</label>
                                <input type="date" id="editDate${index}" value="${booking.date}">
                            </div>
                            <div class="form-group">
                                <label>預約時間</label>
                                <input type="time" id="editTime${index}" value="${booking.time}">
                            </div>
                            <div class="form-group">
                                <label>航班編號</label>
                                <input type="text" id="editFlight${index}" value="${booking.flight || ''}" placeholder="例如: CZ3087">
                            </div>
                            <div class="form-group">
                                <label>上車點</label>
                                <input type="text" id="editDeparture${index}" value="${booking.departure}">
                            </div>
                            <div class="form-group">
                                <label>下車點</label>
                                <input type="text" id="editDestination${index}" value="${booking.destination}">
                            </div>
                            <div class="form-group">
                                <label>備註</label>
                                <textarea id="editNotes${index}" placeholder="其他需求或備註">${booking.notes || ''}</textarea>
                            </div>
                            <div class="edit-actions">
                                <button class="btn btn-secondary" onclick="cancelEdit(${index})">取消修改</button>
                                <button class="btn" onclick="saveEdit(${index})">儲存修改</button>
                            </div>
                        </div>

                        <div class="booking-actions">
                            ${!isCompleted ? `
                                <button class="btn btn-warning btn-small" onclick="startEdit(${index})">修改預約</button>
                                <button class="btn btn-danger btn-small" onclick="confirmCancel('${booking.phone}', '${booking.date}', '${booking.time}')">取消預約</button>
                            ` : ''}
                            <button class="btn btn-secondary btn-small" onclick="copyBooking(${index})">複製預約</button>
                        </div>
                    </div>
                `;
            }).join('');

            listArea.innerHTML = `<div class="booking-list">${listHTML}</div>`;
            localStorage.setItem('currentBookings', JSON.stringify(bookings));
        }

        function startEdit(index) {
            const editForm = document.getElementById(`editForm${index}`);
            editForm.classList.add('show');
        }

        function cancelEdit(index) {
            const editForm = document.getElementById(`editForm${index}`);
            editForm.classList.remove('show');
        }

        async function saveEdit(index) {
            const phone = document.getElementById('searchPhone').value;
            const originalBookings = JSON.parse(localStorage.getItem('currentBookings') || '[]');
            const originalBooking = originalBookings[index];

            const updatedData = {
                action: 'updateBooking',
                phone: phone,
                originalDate: originalBooking.date,
                originalTime: originalBooking.time,
                newDate: document.getElementById(`editDate${index}`).value,
                newTime: document.getElementById(`editTime${index}`).value,
                flight: document.getElementById(`editFlight${index}`).value,
                departure: document.getElementById(`editDeparture${index}`).value,
                destination: document.getElementById(`editDestination${index}`).value,
                notes: document.getElementById(`editNotes${index}`).value
            };

            try {
                const formData = new URLSearchParams();
                Object.keys(updatedData).forEach(key => {
                    formData.append(key, updatedData[key]);
                });

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('預約修改成功！', 'success');
                    setTimeout(() => searchBookings(), 1000);
                } else {
                    showMessage(result.message || '修改失敗，請稍後再試', 'error');
                }
            } catch (error) {
                console.error('修改錯誤:', error);
                showMessage('網路連線異常，請稍後再試', 'error');
            }
        }

        function confirmCancel(phone, date, time) {
            currentAction = 'cancel';
            currentBookingData = { phone, date, time };
            
            document.getElementById('modalTitle').textContent = '取消預約';
            document.getElementById('modalMessage').textContent = `確定要取消 ${date} ${time} 的預約嗎？`;
            document.getElementById('confirmModal').style.display = 'block';
        }

        async function confirmAction() {
            if (currentAction === 'cancel') {
                await cancelBooking();
            }
            closeModal();
        }

        async function cancelBooking() {
            try {
                const formData = new URLSearchParams();
                formData.append('action', 'cancelBooking');
                formData.append('phone', currentBookingData.phone);
                formData.append('date', currentBookingData.date);
                formData.append('time', currentBookingData.time);

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('預約已成功取消', 'success');
                    setTimeout(() => searchBookings(), 1000);
                } else {
                    showMessage(result.message || '取消失敗，請稍後再試', 'error');
                }
            } catch (error) {
                console.error('取消錯誤:', error);
                showMessage('網路連線異常，請稍後再試', 'error');
            }
        }

        function copyBooking(index) {
            const bookings = JSON.parse(localStorage.getItem('currentBookings') || '[]');
            const booking = bookings[index];
            
            if (booking) {
                localStorage.setItem('copyBookingData', JSON.stringify({
                    service: booking.serviceRaw || booking.service,
                    flight: booking.flight,
                    departure: booking.departure,
                    destination: booking.destination,
                    notes: booking.notes
                }));
                
                window.location.href = 'index.html';
            }
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentAction = null;
            currentBookingData = null;
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
